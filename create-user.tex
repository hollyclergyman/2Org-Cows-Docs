% !TEX root = Documentation.tex

\subsection{create-user.php}
The create-user.php site offers the opportunity to create a new user and to set the right for this specific user. User creation follows the idea of dropping rights, 
which only allows a user to create another user with less rights than he has himself. To ensure this, create-user.php is just visible to users with a role, higher than student.
This includes the following roles: admin [role code: 4], professor [role code: 3], scientific coworker [role code: 2]. \\
Furthermore only professors and admins are allowed to create users at a different institution, scientific coworker are only allowed to create users at the 
same institution as they are. In the same way, the erasing of users is limited to professors and admin users.\\
Creating a user leads to modifications in the Dim\_User table and the authentication database. This database updates are proceeded, if the user clicks on 
the ``create user'' button, which calls the ``create\_user\_script.php'' file to process the form data and insert them into the database.\\ 
The creation of new institution is also limited to people logged in as professors and admin. Each department is created separetely, even if an institution owns several departments, 
taking part in the 2Org-Cows project. This improves the adjustability of rights sticked to the specific department in case of splitted user rights on certain datasets.
The data inserted for the creation of an institution are processed by the create\_institution\_script.php file.

\subsection{create\_user\_script.php}
The create\_user\_script.php is the processing file for the entries to create a new user in the web interface for the database. Basically the script just performs the validity checks 
of the form data provided in create-user.php and an \textbf{INSERT} query to the MySQL database.\\
At the beginning the script checks whether the provided check bytes submitted in create-user.php match those from the session. Again this is a CSRF-protection in case the session has
been hijacked. If there are no problems on the CSRF protection, the script checks for the validity of the form provided. This part already takes place in the html, where the tag 
``required'' is set for all fields, but a controll in the script should avoid empty fields in the database.\\
For the validity checks the following steps are taken:
\begin{itemize}
 \item validity check of the e-mail adress provided
 \item check whether the desired username is available
 \item check, whether the password matches matches the control field
 \item check whether the user permissions, entered in the form, are allowed to be performed by the user invoked
 \item check whether the user invoked is allowed to select an institution different from his own
\end{itemize}
If any of these checks fails, the user receives an error notice and is directed to the form.As the group, department and the country entries are stored in a different
way in the database, than in the user session, the database values have to be retrieved from the database. Therefore, the corresponding institution, department and country are 
queried from the Dim\_Group table. As the country is stored as an integer value, the corresponding ID\_Country has to be queried from the Dim\_Country in the next step.\\
The passwords are stored as bcrypt hash values in a separate database, the hashing is performed after the validity checks for the form. The next step is to insert all data into the 
Dim\_User table in the agri\_star\_001 database. The insert is proceeded in an objective style, generating the query first, then assigning the values to the query 
(mysqli::prepare(\$query), mysqli::bind\_param(parameters)) and than executing the query (mysqli::execute). The transaction id of that insert is retrieved, as it is used as ID\_User
to identify the user in the various databases and therefore also in the auth database. In the next step the username, the password hash and the ID\_User are inserted into the 
auth database, using the same process as for the Dim\_User table.\\
The scripts quits with a success message.